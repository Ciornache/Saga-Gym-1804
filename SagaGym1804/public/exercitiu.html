<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Exercise Details – Saga Gym</title>
  <link href="styles/main.css" rel="stylesheet">
  <link href="styles/exercitiu.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Goldman:wght@400;700&display=swap"
    rel="stylesheet">
  <script src="https://kit.fontawesome.com/4f34f92427.js" crossorigin="anonymous"></script>
</head>

<body>
  <div class="page-wrapper">
    <header class="header">
      <div class="logo-container">
        <img src="assets/Web-Logo.png" alt="Saga Gym logo" class="logo">
      </div>
      <div class="header-message">
        <h1>Your path to better health starts today</h1>
        <p>Custom workouts. Real progress. Just for you</p>
      </div>
    </header>

    <nav class="navbar">
      <button class="navbar-button"><span>Home</span><img class="button-arrow" src="assets/bullish-arrow.png" alt=""></button>
      <button class="navbar-button"><span>Exercises</span><img class="button-arrow" src="assets/bullish-arrow.png" alt=""></button>
      <div class="dropdown-wrapper">
        <button class="navbar-button"><span>My Account</span></button>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="login.html"><span>Login</span><img class="button-arrow" src="assets/bullish-arrow.png" alt=""></a>
          <a class="dropdown-item" href="signup.html"><span>Sign Up</span><img class="button-arrow" src="assets/bullish-arrow.png" alt=""></a>
        </div>
      </div>
      <button class="navbar-button"><span>Contact</span><img class="button-arrow" src="assets/bullish-arrow.png" alt=""></button>
    </nav>

    <main>
      <article class="exercise-article">
        <h2 id="exercise-title" data-id="">Loading…</h2>

        <div class="exercise-info-container">
          <div class="exercise-info">
            <button id="write-review-btn" class="btn-review">Write a review</button>
            <p class="score-line">
              <strong>Score:</strong>
              <i class="fa-solid fa-medal stat-icon"></i>
              <span id="score"></span>
            </p>
            <p><strong>Difficulty:</strong> <span id="difficulty"></span></p>
            <p><strong>Targeted Muscles:</strong> <span id="targeted-muscles"></span></p>
            <p><strong>Risk Level:</strong> <span id="risk"></span></p>
            <p><strong>Description:</strong> <span id="short-desc"></span></p>
          </div>

          <div class="exercise-presentation">
            <div class="presentation">
              <div class="image-mode active">
                <img id="exercise-image" src="" alt="Exercise image">
                <i class="fa-solid fa-angles-left prev-image"></i>
                <i class="fa-solid fa-angles-right next-image"></i>
              </div>
              <div class="video-mode">
                <iframe id="exercise-iframe"
                  style="display:none;"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen>
                </iframe>
              </div>
            </div>
            <div class="presentation-modes">
              <i class="fa-solid fa-image image-toggle active"></i>
              <i class="fa-solid fa-video video-toggle"></i>
            </div>
          </div>
        </div>

        <p id="view-more">View More</p>
        <div class="exercise-details hidden">
          <div class="exercise-instructions">
            <h2>How to perform</h2>
            <div id="instructions-container"></div>
          </div>
          <div class="exercise-tips">
            <h2>Tips & Tricks</h2>
            <ol id="tips-list"></ol>
          </div>
        </div>

        <!-- Review Modal -->
        <div id="review-modal" class="modal hidden">
          <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>Leave a review</h3>
            <div id="star-container" class="stars">
              <i data-value="1" class="fa-solid fa-medal"></i>
              <i data-value="2" class="fa-solid fa-medal"></i>
              <i data-value="3" class="fa-solid fa-medal"></i>
              <i data-value="4" class="fa-solid fa-medal"></i>
              <i data-value="5" class="fa-solid fa-medal"></i>
            </div>
            <textarea id="review-comment" rows="4" placeholder="Your comments…"></textarea>
            <button id="submit-review" class="btn-submit">Submit Review</button>
          </div>
        </div>

        <!-- All Reviews -->
        <section id="reviews-section">
          <h3>All Reviews</h3>
          <div id="reviews-list"></div>
        </section>
      </article>
    </main>

    <footer></footer>
  </div>

  <script src="scripts/exercitiu.js"></script>
  <!-- Updated review modal script integrated into exercitiu.html -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const titleEl = document.getElementById('exercise-title');
    const btn = document.getElementById('write-review-btn');
    const modal = document.getElementById('review-modal');
    const close = document.querySelector('.close-modal');
    const stars = Array.from(document.querySelectorAll('#star-container i'));
    const commentInput = document.getElementById('review-comment');
    const submitBtn = document.getElementById('submit-review');
    const reviewsList = document.getElementById('reviews-list');

    let selectedRating = 0;

    btn.onclick = () => modal.classList.remove('hidden');
    close.onclick = () => {
      modal.classList.add('hidden');
      resetStars();
      commentInput.value = '';
    };

    stars.forEach(star => {
      star.addEventListener('mouseover', () => highlight(star.dataset.value));
      star.addEventListener('mouseout', () => highlight(selectedRating));
      star.addEventListener('click', () => {
        selectedRating = +star.dataset.value;
        highlight(selectedRating);
      });
    });

    function highlight(r) {
      stars.forEach(s => s.classList.toggle('selected', +s.dataset.value <= r));
    }

    function resetStars() {
      selectedRating = 0;
      highlight(0);
    }

   submitBtn.onclick = async () => {
  const comment = commentInput.value.trim();
  const exerciseId = document.getElementById("exercise-title").dataset.id;

  const token = localStorage.getItem("token");
  if (!token) {
    alert("Trebuie să fii autentificat pentru a trimite un review.");
    return;
  }

  if (!selectedRating || !comment || !exerciseId) {
    alert('Please select a rating and write a comment.');
    return;
  }

  try {
    const res = await fetch('/api/reviews', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ exerciseId, rating: selectedRating, comment })
    });
    if (!res.ok) throw new Error(await res.text());
    await loadReviews(exerciseId);
    modal.classList.add('hidden');
    resetStars();
    commentInput.value = '';
  } catch (err) {
    alert('Could not submit review.');
  }
};

    async function loadReviews(exerciseId) {
      try {
        const res = await fetch(`/api/reviews?exerciseId=${exerciseId}`);
        if (!res.ok) throw new Error();
        const list = await res.json();
        reviewsList.innerHTML = '';
        list.forEach(r => {
          const div = document.createElement('div');
          div.className = 'review-item';
          const starHtml = Array(5).fill().map((_, i) =>
            `<i class="fa-solid fa-medal" style="color:${i < r.rating ? '#e76f66' : '#bbb'}"></i>`).join('');
          div.innerHTML = `
            <div class="stars">${starHtml}</div>
            <p>${r.comment.replace(/\n/g, '<br>')}</p>
            <small>${new Date(r.createdAt).toLocaleString("ro-RO", { dateStyle: "medium", timeStyle: "short" })}</small>
          `;
          reviewsList.appendChild(div);
        });
      } catch {
        reviewsList.innerHTML = "<p style='color:red'>Eroare la încărcarea recenziilor</p>";
      }
    }

    const exerciseId = document.getElementById("exercise-title").dataset.id;
    if (exerciseId) loadReviews(exerciseId);
  });
</script>
</body>

</html>
